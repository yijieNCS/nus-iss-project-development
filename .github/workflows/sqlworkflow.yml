name: APITestingWorkflow

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  sqlDatabaseSetup:
    runs-on: ubuntu-latest
    outputs:
        dbHost: ${{ job.services.mysql.ports[3306] }}
        dbPort: ${{ job.services.mysql.ports[3306] }}
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_database
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: ./backend
      run: npm install

    - name: Install MySQL client
      run: sudo apt-get install -y mysql-client

    - name: Create user table
      run: |
        mysql -h 127.0.0.1 -P 3306 -u test_user -p'test_password' test_database -e 'CREATE TABLE tbl_User (userID INT NOT NULL AUTO_INCREMENT PRIMARY KEY, age INT NOT NULL, dateJoined DATETIME DEFAULT NULL, firstName VARCHAR(25) NOT NULL, lastName VARCHAR(25) NOT NULL,
        email VARCHAR(25) NOT NULL, education VARCHAR(100) NOT NULL,username VARCHAR(255) UNIQUE NOT NULL, password VARCHAR(255) NOT NULL, birthDate DATETIME DEFAULT NULL, gender VARCHAR(1) NOT NULL);'

    - name: Create session table
      run: |
        mysql -h 127.0.0.1 -P 3306 -u test_user -p'test_password' test_database -e 'CREATE TABLE `sessions` (`sessionId` INT NOT NULL AUTO_INCREMENT, `tutorId` INT NOT NULL, `studentId` INT NOT NULL, `timing` DATETIME NOT NULL, `status` VARCHAR(10) NOT NULL, `location` VARCHAR(25) NOT NULL, PRIMARY KEY (`sessionId`), FOREIGN KEY (`tutorId`) REFERENCES tbl_User(`userID`), FOREIGN KEY (`studentId`) REFERENCES tbl_User(`userID`));'

    - name: Run User Tests
      env:
        DB_HOST: ${{ job.outputs.dbHost }}
        DB_USER: test_user
        DB_PASSWORD: test_password
        DB_DATABASE: test_database
      run: npm run test:user
      working-directory: backend

    - name: Run Session Tests
      env:
        DB_HOST: ${{ job.outputs.dbHost }}
        DB_USER: test_user
        DB_PASSWORD: test_password
        DB_DATABASE: test_database
      run: npm run test:session
      working-directory: backend
    


